const closeModalBtn = document.querySelector(".close-modal__btn");
document.addEventListener("DOMContentLoaded", function () {
	const query = {};
	let currentPage = 1;
	let currentPageCard = 1;

	document.querySelectorAll(".num__content").forEach((elem) => {
		var name = elem.getAttribute("data-bs-value");
		const value = elem.textContent.trim();
		if (value != "*") query[name] = value;
	});

	document.querySelectorAll(".number_menu").forEach(function (menu) {
		menu.addEventListener("click", function (event) {
			var target = event.target;
			if (target.tagName === "LI") {
				var input = target
					.closest(".wrap-item-group")
					.querySelector(".num__content");
				var ac__class = target
					.closest(".wrap-item-group")
					.querySelector(".ac__class");
				if (ac__class) {
					ac__class.classList.add("num__content--active");
				}
				if (input) {
					input.textContent = target.textContent;
					document.querySelectorAll(".number_menu").forEach((item) => {
						item.classList.remove("active");
						document
							.querySelector(".number_menu--close")
							.classList.remove("active");
					});
				}
				var name = input.getAttribute("data-bs-value");
				var value = input.textContent
				query[name] = value;

				// start
				const params = new URLSearchParams(query);
				const url = `/api/numbers?${params.toString()}`;

				// Fetch API yordamida so'rov yuboramiz
				try {
					filterNumbers(url);
				} catch (error) {
					
				}
			}
		});
	});
	document
		.querySelector(".number_menu--close")
		.addEventListener("click", function (event) {
			document.querySelectorAll(".number_menu").forEach((item) => {
				item.classList.remove("active");
				document
					.querySelector(".number_menu--close")
					.classList.remove("active");
			});
		});
	document.querySelectorAll(".num__content").forEach(function (menu) {
		menu.addEventListener("click", function (event) {
			var number_menu = event.target
				.closest(".wrap-item-group")
				.querySelector(".number_menu");
			document.querySelectorAll(".number_menu").forEach((item) => {
				item.classList.remove("active");
				document
					.querySelector(".number_menu--close")
					.classList.remove("active");
			});
			number_menu.classList.add("active");
			document.querySelector(".number_menu--close").classList.add("active");
		});
	});

	// loaded data number katalog
	document
		.querySelector(".sale-table__bottom-btn")
		.addEventListener("click", () => {
			// Sahifa sonini oshiramiz
			currentPage++;

			const params = new URLSearchParams(query);
			params.append("page", currentPage); // Sahifa sonini parametrlarga qo'shamiz

			const url = `/api/numbers?${params.toString()}`;


			// Fetch API yordamida yangi so'rov yuboramiz
			try {
				fetch(url)
					.then((response) => response.json())
					.then((data) => {
						const saleTableBody = document.querySelector(".sale-table__body");
						// Kelgan natijalarni sahifaga qo'shamiz
						data.forEach((number) => {
							let formattedPrice = parseFloat(number.amount);
							let amount = formattedPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " " + "₽";
							number.amount = amount
							const numberHTML = `
						<div class="table__body-item">
						<div class="sale-table__container">
							<div class="row">
							<div class="col-5">
								<div class="item-car__number">
								<div class="number__left">
									<h2>${number.letter1}</h2>
									<div class="item-min__number">
									<h1>${number.number1}</h1>
									<h1>${number.number2}</h1>
									<h1>${number.number3}</h1>
									</div>
									<h2>${number.letter2}${number.letter3}</h2>
								</div>
								<div class="number__right">
									<h2>${number.regionNumber}</h2>
									<div class="right-country">
									<h4>rus</h4><img src="/img/icons/ru-flag.svg" alt="">
									</div>
								</div>
								</div>
							</div>
							<div class="col-3">
								<h3 class="sale-table__region">${number.region.name}</h3>
							</div>
							<div class="col-2">
								<h3 class="sale-table__price">${number.amount}</h3>
							</div>
							<div class="col-2">
								<button class="sale-teble__btn puy-modal__btn"
									type="button">Купить</button></div>
							</div>
						</div>
						</div>
						`;
							saleTableBody.insertAdjacentHTML("beforeend", numberHTML);
							modalFunction()
						});
					})
					.catch((error) => {
						console.log("Error:", error);
					});
			} catch (error) {
				console.log(error)
			}
		});
});

let homeModalBoolean = true;
const modalCloseBody = document.querySelector(".close-modal__body");
const modalContent = document.querySelector("#modal__content");
const homeModal = document.querySelector(".home-modal");

function modalFunction () {
	document.querySelectorAll(".puy-modal__btn").forEach((btn) => {
		btn.addEventListener("click", () => {
			if (homeModalBoolean) {
				modalContent.textContent = 'Выберите, куда удобнее будет отправить список номеров'
				document.body.style.overflow = "hidden";
				homeModal.classList.add("active");
				modalCloseBody.classList.add("closeModal--active");
				closeModalBtn.classList.add("close-modal__btn--active");
				homeModalBoolean = false;
			}
		});
	});
}
modalFunction()

modalCloseBody.addEventListener("click", () => {
	if (homeModalBoolean !== true) {
		homeModal.classList.remove("active");
		modalCloseBody.classList.remove("closeModal--active");
		closeModalBtn.classList.remove("close-modal__btn--active");
		document.body.style.overflow = "auto";
		homeModalBoolean = true;
	}
	if (navbarBoolean !== true) {
		document.querySelector(".navbar-menu").classList.remove("active");
		modalCloseBody.classList.remove("closeModal--active");
		navbarBoolean = true;
	}
});

closeModalBtn.addEventListener("click", () => {
	if (homeModalBoolean !== true) {
		document.body.style.overflow = "auto";
		modalCloseBody.classList.remove("closeModal--active");
		homeModal.classList.remove("active");
		closeModalBtn.classList.remove("close-modal__btn--active");
		homeModalBoolean = true;
	}
});
let navbarBoolean = true;
function navbar() {
	if (navbarBoolean) {
		modalCloseBody.classList.add("closeModal--active");
		document.querySelector(".navbar-menu").classList.add("active");
		navbarBoolean = false;
	}
}
document.querySelector(".navbar-menu__btn").addEventListener("click", () => {
	if (navbarBoolean !== true) {
		document.querySelector(".navbar-menu").classList.remove("active");
		modalCloseBody.classList.remove("closeModal--active");
		navbarBoolean = true;
	}
});

function filterNumbers(url) {
	try {
		fetch(url)
			.then((response) => response.json()) // Javobni JSON sifatida o'qish
			.then((data) => {
				const saleTableBody = document.querySelector(".sale-table__body");
				saleTableBody.innerHTML = ""; // Avvalgi ma'lumotlarni tozalaymiz
				
				if (!data.message) {
					
					data.forEach((number) => {
						// Har bir number uchun HTML quramiz
						let formattedPrice = parseFloat(number.amount);
						let amount = formattedPrice.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".") + " " + "₽";
						number.amount = amount
						
						const numberHTML = `
						  <div class="table__body-item">
						  <div class="sale-table__container">
							  <div class="row">
							  <div class="col-5">
								  <div class="item-car__number">
								  <div class="number__left">
									  <h2>${number.letter1}</h2>
									  <div class="item-min__number">
									  <h1>${number.number1}</h1>
									  <h1>${number.number2}</h1>
									  <h1>${number.number3}</h1>
									  </div>
									  <h2>${number.letter2}${number.letter3}</h2>
								  </div>
								  <div class="number__right">
									  <h2>${number.regionNumber}</h2>
									  <div class="right-country">
									  <h4>rus</h4><img src="/img/icons/ru-flag.svg" alt="">
									  </div>
								  </div>
								  </div>
							  </div>
							  <div class="col-3">
								  <h3 class="sale-table__region">${number.region.name}</h3>
							  </div>
							  <div class="col-2">
								  <h3 class="sale-table__price">${number.amount}</h3>
							  </div>
							  	<div class="col-2">
									<button class="sale-teble__btn puy-modal__btn" type="button">Купить</button>
								</div>
							  </div>
						  </div>
						  </div>
						  `;
						// Qurilgan HTMLni saleTableBody ichiga qo'shamiz
						saleTableBody.insertAdjacentHTML("beforeend", numberHTML);
						modalFunction()
					});
				}else{
					if (homeModalBoolean) {
						modalContent.textContent = 'Не нашли нужный номер? Позвоните нам и мы найдем его '
						document.body.style.overflow = "hidden";
						homeModal.classList.add("active");
						modalCloseBody.classList.add("closeModal--active");
						closeModalBtn.classList.add("close-modal__btn--active");
						homeModalBoolean = false;
					}
				}
			})
			.catch((error) => {
				// console.log("Error:", error);
				// console.log('saleTableBody')
			});
	} catch (error) {
		// console.log('saleTableBody');
	}
}
