const closeModalBtn = document.querySelector(".close-modal__btn");
document.addEventListener("DOMContentLoaded", function () {
  const query = {};
  let currentPage = 1;
  let currentPageCard = 1;

  document.querySelectorAll(".num__content").forEach((elem) => {
    var name = elem.getAttribute("data-bs-value");
    const value = elem.textContent.trim();
    if (value != "*") query[name] = value;
  });

  document.querySelectorAll(".number_menu").forEach(function (menu) {
    menu.addEventListener("click", function (event) {
      var target = event.target;
      if (target.tagName === "LI") {
        var input = target
          .closest(".wrap-item-group")
          .querySelector(".num__content");
        var ac__class = target
          .closest(".wrap-item-group")
          .querySelector(".ac__class");
        if (ac__class) {
          ac__class.classList.add("num__content--active");
        }
        if (input) {
          input.textContent = target.textContent;
          document.querySelectorAll(".number_menu").forEach((item) => {
            item.classList.remove("active");
            document
              .querySelector(".number_menu--close")
              .classList.remove("active");
          });
        }
        var name = input.getAttribute("data-bs-value");
        var value = input.textContent
        query[name] = value;

        document.querySelectorAll(".num__content").forEach((elem) => {
          var name = elem.getAttribute("data-bs-value");
          const value = elem.textContent.trim();
          // if (value = "*") query[name] = null
        });

        console.log(query);

        // start
        const params = new URLSearchParams(query);
        const url = `/api/numbers?${params.toString()}`;

        // Fetch API yordamida so'rov yuboramiz
        filterNumbers(url);
      }
    });
  });
  document
    .querySelector(".number_menu--close")
    .addEventListener("click", function (event) {
      document.querySelectorAll(".number_menu").forEach((item) => {
        item.classList.remove("active");
        document
          .querySelector(".number_menu--close")
          .classList.remove("active");
      });
    });
  document.querySelectorAll(".num__content").forEach(function (menu) {
    menu.addEventListener("click", function (event) {
      var number_menu = event.target
        .closest(".wrap-item-group")
        .querySelector(".number_menu");
      document.querySelectorAll(".number_menu").forEach((item) => {
        item.classList.remove("active");
        document
          .querySelector(".number_menu--close")
          .classList.remove("active");
      });
      number_menu.classList.add("active");
      document.querySelector(".number_menu--close").classList.add("active");
    });
  });

  // loaded data number katalog
  document
    .querySelector(".sale-table__bottom-btn")
    .addEventListener("click", () => {
      // Sahifa sonini oshiramiz
      currentPage++;

      const params = new URLSearchParams(query);
      params.append("page", currentPage); // Sahifa sonini parametrlarga qo'shamiz

      const url = `/api/numbers?${params.toString()}`;

	  
      // Fetch API yordamida yangi so'rov yuboramiz
	  try {
		fetch(url)
		  .then((response) => response.json())
		  .then((data) => {
			const saleTableBody = document.querySelector(".sale-table__body");
			// Kelgan natijalarni sahifaga qo'shamiz
			data.forEach((number) => {
			  const numberHTML = `
			<div class="table__body-item">
			<div class="sale-table__container">
				<div class="row">
				<div class="col-5">
					<div class="item-car__number">
					<div class="number__left">
						<h2>${number.letter1}</h2>
						<div class="item-min__number">
						<h1>${number.number1}</h1>
						<h1>${number.number2}</h1>
						<h1>${number.number3}</h1>
						</div>
						<h2>${number.letter2}${number.letter3}</h2>
					</div>
					<div class="number__right">
						<h2>${number.regionNumber}</h2>
						<div class="right-country">
						<h4>rus</h4><img src="/img/icons/ru-flag.svg" alt="">
						</div>
					</div>
					</div>
				</div>
				<div class="col-3">
					<h3 class="sale-table__region">${number.region.name}</h3>
				</div>
				<div class="col-2">
					<h3 class="sale-table__price">${number.amount} ₽</h3>
				</div>
				<div class="col-2"><button class="sale-teble__btn puy-modal__btn"
						type="button">Купить</button></div>
				</div>
			</div>
			</div>
			`;
			  saleTableBody.insertAdjacentHTML("beforeend", numberHTML);
			});
		  })
		  .catch((error) => {
			console.log("Error:", error);
		  });
	  } catch (error) {
		console.log(error)
	  }
    });

  // loaded data number cards
  document
    .querySelector(".decoration-wrap__btn")
    .addEventListener("click", () => {
      // Sahifa sonini oshiramiz
      currentPageCard++;

      const params = new URLSearchParams(query);
      params.append("page", currentPageCard); // Sahifa sonini parametrlarga qo'shamiz

      const url = `/api/numbers?${params.toString()}`;

	  try {
		fetch(url)
		  .then((response) => response.json())
		  .then((data) => {
			const saleTableBody = document.querySelector("#decoration-cards");
			// Kelgan natijalarni sahifaga qo'shamiz
			data.forEach((number) => {
  
			  const date = new Date(number.createdAt);
			  // Sana komponentlarini olish
			  const day = date.getDate().toString().padStart(2, '0');
			  const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Oy 0 dan boshlanadi, shuning uchun 1 qo'shamiz
			  const year = date.getFullYear();
  
			  const numberHTML = `
			  <div class="col-xl-4 col-lg-4 col-md-6 col-sm-6">
				  <div class="decoration-card">
					  <div class="card-img"><img src="${number.image}" alt=""></div>
					  <div class="card-about">
						  <h5><span style="text-transform: uppercase;">${number.letter1}${number.number1}${number.number2}${number.number3}${number.letter2}${number.letter3} ${number.regionNumber}</span> | <span>${number.region.name}</span></h5>
						  <h5><span>Одинаковые цифры</span> | <span>Цена до: ${day}.${month}.${year}</span></h5><button
							  class="puy-modal__btn card__btn">${number.amount} ₽ / Купить</button>
					  </div>
				  </div>
			  </div>
				`;
			  saleTableBody.insertAdjacentHTML("beforeend", numberHTML);
			});
		  })
		  .catch((error) => {
			console.log("Error:", error);
		  });
	  } catch (error) {
		console.log(error);
	  }
      // Fetch API yordamida yangi so'rov yuboramiz
    });
});
let homeModalBoolean = true;
const modalCloseBody = document.querySelector(".close-modal__body");
const homeModal = document.querySelector(".home-modal");
document.querySelectorAll(".puy-modal__btn").forEach((btn) => {
  btn.addEventListener("click", () => {
    if (homeModalBoolean) {
      document.body.style.overflow = "hidden";
      homeModal.classList.add("active");
      modalCloseBody.classList.add("closeModal--active");
      closeModalBtn.classList.add("close-modal__btn--active");
      homeModalBoolean = false;
    }
  });
});
modalCloseBody.addEventListener("click", () => {
  if (homeModalBoolean !== true) {
    homeModal.classList.remove("active");
    modalCloseBody.classList.remove("closeModal--active");
    closeModalBtn.classList.remove("close-modal__btn--active");
    document.body.style.overflow = "auto";
    homeModalBoolean = true;
  }
  if (navbarBoolean !== true) {
    document.querySelector(".navbar-menu").classList.remove("active");
    modalCloseBody.classList.remove("closeModal--active");
    navbarBoolean = true;
  }
});

closeModalBtn.addEventListener("click", () => {
  if (homeModalBoolean !== true) {
    document.body.style.overflow = "auto";
    modalCloseBody.classList.remove("closeModal--active");
    homeModal.classList.remove("active");
    closeModalBtn.classList.remove("close-modal__btn--active");
    homeModalBoolean = true;
  }
});
let navbarBoolean = true;
function navbar() {
  if (navbarBoolean) {
    modalCloseBody.classList.add("closeModal--active");
    document.querySelector(".navbar-menu").classList.add("active");
    navbarBoolean = false;
  }
}
document.querySelector(".navbar-menu__btn").addEventListener("click", () => {
  if (navbarBoolean !== true) {
    document.querySelector(".navbar-menu").classList.remove("active");
    modalCloseBody.classList.remove("closeModal--active");
    navbarBoolean = true;
  }
});

function filterNumbers(url) {
	try {
		fetch(url)
		  .then((response) => response.json()) // Javobni JSON sifatida o'qish
		  .then((data) => {
			console.log(data);
			const saleTableBody = document.querySelector(".sale-table__body");
			saleTableBody.innerHTML = ""; // Avvalgi ma'lumotlarni tozalaymiz
	  
			if(!data.message){
				// Har bir number uchun HTML quramiz
				data.forEach((number) => {
				  const numberHTML = `
						  <div class="table__body-item">
						  <div class="sale-table__container">
							  <div class="row">
							  <div class="col-5">
								  <div class="item-car__number">
								  <div class="number__left">
									  <h2>${number.letter1}</h2>
									  <div class="item-min__number">
									  <h1>${number.number1}</h1>
									  <h1>${number.number2}</h1>
									  <h1>${number.number3}</h1>
									  </div>
									  <h2>${number.letter2}${number.letter3}</h2>
								  </div>
								  <div class="number__right">
									  <h2>${number.regionNumber}</h2>
									  <div class="right-country">
									  <h4>rus</h4><img src="/img/icons/ru-flag.svg" alt="">
									  </div>
								  </div>
								  </div>
							  </div>
							  <div class="col-3">
								  <h3 class="sale-table__region">${number.region.name}</h3>
							  </div>
							  <div class="col-2">
								  <h3 class="sale-table__price">${number.amount} ₽</h3>
							  </div>
							  <div class="col-2"><button class="sale-teble__btn puy-modal__btn"
									  type="button">Купить</button></div>
							  </div>
						  </div>
						  </div>
						  `;
				  // Qurilgan HTMLni saleTableBody ichiga qo'shamiz
				  saleTableBody.insertAdjacentHTML("beforeend", numberHTML);
				});
			}
		  })
		  .catch((error) => {
			console.log("Error:", error);
		  });
	} catch (error) {
		console.log(error);
	}
}
